<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Machiavelli AI â€” Geopolitics Chat</title>
  <style>
    :root { --bg:#0f0f12; --panel:#17171c; --ink:#eaeaf0; --muted:#a4a6b3; --accent:#c9aa71; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial,sans-serif}
    header{padding:20px 16px;border-bottom:1px solid #2a2b32;background:linear-gradient(180deg,#121218,#0f0f12)}
    h1{margin:0;font-size:20px;font-weight:700;display:flex;gap:10px;align-items:center}
    h1 span.logo{display:inline-flex;width:28px;height:28px;border-radius:8px;background:#1e1f26;align-items:center;justify-content:center;border:1px solid #2a2b32}
    h1 small{color:var(--muted);font-weight:500}
    main{display:grid;grid-template-rows:1fr auto; height:calc(100dvh - 66px);}
    #chat{padding:16px;overflow:auto;display:flex;flex-direction:column;gap:14px}
    .bubble{max-width:900px;width:100%;margin:0 auto;padding:14px 16px;border-radius:14px;border:1px solid #2a2b32;background:var(--panel);line-height:1.5;white-space:pre-wrap}
    .user{border-color:#3b3d48;background:#1b1c22}
    .assistant{border-color:#2c2d35}
    .meta{font-size:12px;color:var(--muted);margin-bottom:6px}
    form{display:flex;gap:10px;padding:10px 16px;border-top:1px solid #2a2b32;background:#101015;align-items:center;flex-wrap:wrap}
    textarea{flex:1;resize:none;min-height:52px;max-height:180px;border-radius:12px;border:1px solid #2a2b32;background:#14151b;color:var(--ink);padding:12px;outline:none}
    button{padding:12px 16px;border-radius:12px;border:1px solid #393a44;background:#1c1d24;color:var(--ink);cursor:pointer}
    button.primary{background:var(--accent);border-color:#9a7b3b;color:#0a0b0f;font-weight:700}
    .note{max-width:900px;margin:8px auto;color:var(--muted);font-size:13px;padding:0 16px 10px}
    a{color:#d7bf86}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .hidden{display:none}
    .tag{font-size:11px;border:1px solid #3b3d48;padding:2px 8px;border-radius:999px;color:var(--muted)}
    label.switch{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--muted)}
    label.switch input{accent-color:#c9aa71;transform:scale(1.2)}
    .citations{font-size:12px;color:#b8a57a;margin-top:6px;display:none}
    .citations.on{display:block}
  </style>
</head>
<body>
  <header>
    <h1><span class="logo">ðŸ¦Š</span> Machiavelli AI <small>â€” Geopolitics only</small></h1>
    <div class="note">
      This chatbot speaks as <em>NiccolÃ² Machiavelli</em>. Scope: geopolitics, states, wars, alliances, leaders. 
      It can cite <em>The Prince</em> and a study guide for context when the toggle is on.
      <span class="tag">no personal advice</span>
      <span class="tag">appearances vs reality</span>
      <span class="tag">virtÃ¹ &amp; fortuna</span>
    </div>
  </header>
  <main>
    <div id="chat"></div>
    <form id="composer">
      <textarea id="input" placeholder="Ask Machiavelli about a modern leader, war, or allianceâ€¦" required></textarea>
      <div class="row">
        <label class="switch"><input type="checkbox" id="toggleCite"> Show citations</label>
        <button type="submit" class="primary">Ask</button>
      </div>
    </form>
  </main>

<script>
const chat = document.getElementById('chat');
const form = document.getElementById('composer');
const input = document.getElementById('input');
const toggleCite = document.getElementById('toggleCite');

let KNOWLEDGE = { prince: '', starter: '' };
async function loadKnowledge() {
  const [p, s] = await Promise.all([
    fetch('the_prince.txt').then(r => r.ok ? r.text() : ''),
    fetch('machiavelli_starter_pack.txt').then(r => r.ok ? r.text() : '')
  ]);
  KNOWLEDGE.prince = p;
  KNOWLEDGE.starter = s;
}
loadKnowledge();

function esc(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;')}

function addBubble(role, html) {
  const wrap = document.createElement('div');
  wrap.className = 'bubble ' + (role === 'user' ? 'user' : 'assistant');
  wrap.innerHTML = (role === 'user' ? `<div class="meta">You</div>` : `<div class="meta">Machiavelli</div>`) + 
    `<div class="content">${html}</div><div class="citations"></div>`;
  chat.appendChild(wrap);
  chat.scrollTop = chat.scrollHeight;
  return wrap;
}

function setCitationsVisibility(bubble) {
  const c = bubble.querySelector('.citations');
  if (!c) return;
  c.className = 'citations' + (toggleCite.checked ? ' on' : '');
}

addBubble('assistant', "I am NiccolÃ² Machiavelli. Ask me of princes and republics â€” wars, alliances, leaders. I judge by <em>virtÃ¹</em> and <em>fortuna</em>, not by dreams.");

const API_BASE = '/api/chat'; // non-stream fallback
const API_STREAM = '/api/chat/stream'; // streaming endpoint

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const q = input.value.trim();
  if (!q) return;
  const userBubble = addBubble('user', esc(q).replace(/\n/g,'<br>'));
  input.value = '';
  const botBubble = addBubble('assistant', 'â€¦');
  setCitationsVisibility(botBubble);

  // build payload
  const persona = `You are NiccolÃ² Machiavelli (1469â€“1527), Florentine diplomat and author of The Prince and Discourses on Livy.
Speak sharply, using maxims and historical analogies (Rome, Renaissance Italy). Scope is geopolitics only: states, wars, alliances, and leaders.
Decline off-topic personal matters. Always frame answers in terms of virtÃ¹ (boldness + cunning), fortuna (fortune), fear vs love, cruelty well used, appearances vs reality, arms vs promises.
${toggleCite.checked ? "When relevant, include brief bracket citations like [Prince XVII] or [Starter: Mercenaries]. Place them inline at the end of sentences they support." : ""}`;

  const payload = {
    persona,
    knowledge: {
      the_prince: KNOWLEDGE.prince,
      starter_pack: KNOWLEDGE.starter
    },
    messages: [
      { role: 'system', content: 'You only discuss geopolitics and leadership. If asked about personal topics, reply: "I concern myself only with the conduct of princes and republics."' },
      { role: 'user', content: q }
    ]
  };

  // stream response
  try {
    const res = await fetch(API_STREAM, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if (!res.ok || !res.body) throw new Error('Network error');
    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let acc = '';
    let cited = new Set();
    while (true) {
      const {value, done} = await reader.read();
      if (done) break;
      const chunk = decoder.decode(value, { stream: true });
      // SSE format: lines starting with "data: "
      const lines = chunk.split(/\r?\n/);
      for (const line of lines) {
        if (!line.startsWith('data:')) continue;
        const data = line.slice(5).trim();
        if (data === '[DONE]') continue;
        try {
          const obj = JSON.parse(data);
          const delta = obj.choices?.[0]?.delta?.content || '';
          if (delta) {
            acc += delta;
            botBubble.querySelector('.content').textContent = acc; // raw text during stream
            // extract simple bracket citations to show separately too
            const refs = acc.match(/\[(?:Prince\s+[IVXLCDM]+|Prince\s+\w+|Starter:[^\]]+)\]/g);
            const citeBox = botBubble.querySelector('.citations');
            if (refs && citeBox) {
              citeBox.textContent = Array.from(new Set(refs)).join('  ');
              setCitationsVisibility(botBubble);
            }
            chat.scrollTop = chat.scrollHeight;
          }
        } catch {}
      }
    }
    // Final formatting: convert newlines to <br> and escape HTML
    botBubble.querySelector('.content').innerHTML = esc(acc).replace(/\n/g,'<br>');
  } catch (err) {
    botBubble.querySelector('.content').textContent = 'Error: ' + err.message + ' â€” check your Worker/API stream setup.';
  }
});
</script>
</body>
</html>
